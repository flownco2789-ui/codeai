<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CodeAI 강사 페이지</title>
  <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <script src="codeai-config.js"></script>
  <script src="codeai-api.js"></script>
  <style>
    body { background:#f7f8fb; }
    .card { border-radius:16px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .muted { color:#6c757d; }
  </style>
</head>
<body>
  <div class="container py-4">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <div>
        <h3 class="mb-1">강사 페이지</h3>
        <div class="muted">학생 상담 → 결제요청(스마트스토어) → 리포트 작성(검수) 흐름</div>
      </div>
      <div class="text-end">
        <a href="index.html" class="btn btn-sm btn-outline-secondary">홈으로</a>
      </div>
    </div>

    <div id="loginCard" class="card p-3 mb-3">
      <div class="row g-2 align-items-end">
        <div class="col-md-5">
          <label class="form-label">이메일</label>
          <input id="email" class="form-control" placeholder="demo-instructor@codeai.co.kr">
        </div>
        <div class="col-md-5">
          <label class="form-label">비밀번호</label>
          <input id="password" type="password" class="form-control" placeholder="teacher1234!">
        </div>
        <div class="col-md-2">
          <button id="loginBtn" class="btn btn-primary w-100">로그인</button>
        </div>
      </div>
      <div id="loginMsg" class="small mt-2 muted"></div>
    </div>

    <div id="app" class="d-none">
      <div class="d-flex justify-content-between mb-2">
        <div class="muted small">※ 학생 연락처는 “학생이 강사를 선택한 후”에만 노출됩니다.</div>
        <button id="logoutBtn" class="btn btn-sm btn-outline-secondary">로그아웃</button>
      </div>

      <div id="list"></div>
    </div>
  </div>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);
  const TOKEN_KEY = "codeai_instructor_token";
  function esc(s){ return String(s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }

  async function login(){
    $("loginMsg").textContent = "로그인 중…";
    try{
      const out = await CodeAI.request("/api/v1/instructor/auth/login", {
        method:"POST",
        body: JSON.stringify({ email: $("email").value.trim(), password: $("password").value })
      });
      localStorage.setItem(TOKEN_KEY, out.token);
      $("loginCard").classList.add("d-none");
      $("app").classList.remove("d-none");
      await load();
      $("loginMsg").textContent = "";
    }catch(e){
      $("loginMsg").textContent = "로그인 실패: " + e.message;
    }
  }

  async function load(){
    const out = await CodeAI.authRequest("/api/v1/instructor/enrollments", TOKEN_KEY, { method:"GET" });
    const list = out.list || [];
    const wrap = $("list");
    wrap.innerHTML = "";
    if(!list.length){
      wrap.innerHTML = "<div class='card p-3 muted'>배정된 학생이 없습니다.</div>";
      return;
    }

    list.forEach(enr=>{
      const sa = enr.studentApplication || {};
      const payments = (enr.payments || []);
      const pay = payments.length ? payments[payments.length-1] : null;

      const el = document.createElement("div");
      el.className = "card p-3 mb-3";
      el.innerHTML = `
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <div class="h6 mb-1">#${enr.id} <span class="badge text-bg-primary">${esc(enr.status)}</span></div>
            <div class="muted small">학생: ${esc(sa.name)} · ${esc(sa.phone)}</div>
            <div class="muted small">과목: ${esc(String(sa.subjects||""))}</div>
            <div class="muted small">방식: ${esc(sa.mode||"")} ${sa.region ? "· " + esc(sa.region) : ""}</div>
          </div>
          <div class="text-end">
            <button class="btn btn-sm btn-outline-primary mb-2" data-consult="${enr.id}">상담 완료</button><br/>
            <button class="btn btn-sm btn-primary" data-pay="${enr.id}">결제 요청</button>
          </div>
        </div>

        <div class="mt-3 p-3" style="background:#f3f5fb;border-radius:12px;">
          <div class="fw-semibold">리포트 작성</div>
          <div class="row g-2 mt-1">
            <div class="col-md-3">
              <select class="form-select form-select-sm" data-type="${enr.id}">
                <option value="PROJECT">프로젝트형</option>
                <option value="ALGORITHM">알고리즘형</option>
              </select>
            </div>
            <div class="col-md-9">
              <input class="form-control form-control-sm" data-title="${enr.id}" placeholder="리포트 제목">
            </div>
            <div class="col-md-6">
              <textarea class="form-control form-control-sm" rows="3" data-summary="${enr.id}" placeholder="요약(선택)"></textarea>
            </div>
            <div class="col-md-6">
              <textarea class="form-control form-control-sm" rows="3" data-feedback="${enr.id}" placeholder="강사 첨삭/의견"></textarea>
            </div>
            <div class="col-md-6">
              <input class="form-control form-control-sm" data-score="${enr.id}" placeholder="점수(알고리즘형, 선택)">
            </div>
            <div class="col-md-6">
              <input class="form-control form-control-sm mono" data-series="${enr.id}" placeholder='성장곡선 JSON (선택) 예: [{"date":"1/1","score":70}]'>
            </div>
            <div class="col-12 d-flex justify-content-end">
              <button class="btn btn-sm btn-success" data-report="${enr.id}">리포트 제출(검수대기)</button>
            </div>
          </div>
          <div class="small muted mt-2">※ 제출된 리포트는 관리자 승인 후 학부모 포털에 표시됩니다.</div>
        </div>

        <div class="mt-3 small muted">
          결제상태: ${pay ? esc(pay.status) : "없음"} ${pay && pay.smartstore_product_url ? `· <a href="${esc(pay.smartstore_product_url)}" target="_blank">결제링크</a>` : ""}
        </div>
      `;
      wrap.appendChild(el);
    });

    wrap.querySelectorAll("[data-consult]").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const id = btn.getAttribute("data-consult");
        await CodeAI.authRequest(`/api/v1/instructor/enrollments/${id}/consult-done`, TOKEN_KEY, { method:"PUT" });
        alert("상담 완료 처리되었습니다.");
        load();
      });
    });

    wrap.querySelectorAll("[data-pay]").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const id = btn.getAttribute("data-pay");
        const amount = prompt("결제 금액(원)을 입력해 주세요.");
        if(!amount) return;
        const title = prompt("상품명(표시용)을 입력해 주세요.", "CodeAI 수강결제");
        const out = await CodeAI.authRequest(`/api/v1/instructor/enrollments/${id}/request-payment`, TOKEN_KEY, {
          method:"POST",
          body: JSON.stringify({ amount: Number(amount), title: title || "CodeAI 수강결제" })
        });
        alert("결제요청 완료. " + (out.paymentUrl ? "결제링크 생성됨" : "스마트스토어 자동생성 미설정/실패(관리자 수동처리 가능)"));
        load();
      });
    });

    wrap.querySelectorAll("[data-report]").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const id = btn.getAttribute("data-report");
        const type = wrap.querySelector(`[data-type="${id}"]`).value;
        const title = wrap.querySelector(`[data-title="${id}"]`).value.trim();
        const summary = wrap.querySelector(`[data-summary="${id}"]`).value.trim();
        const feedback = wrap.querySelector(`[data-feedback="${id}"]`).value.trim();
        const scoreRaw = wrap.querySelector(`[data-score="${id}"]`).value.trim();
        const seriesRaw = wrap.querySelector(`[data-series="${id}"]`).value.trim();

        if(!title){ alert("리포트 제목을 입력해 주세요."); return; }

        let rawData = null;
        if(seriesRaw){
          try { rawData = { scores: JSON.parse(seriesRaw) }; } catch(e){ alert("성장곡선 JSON 형식이 올바르지 않습니다."); return; }
        }

        await CodeAI.authRequest("/api/v1/instructor/reports", TOKEN_KEY, {
          method:"POST",
          body: JSON.stringify({
            enrollmentId: Number(id),
            type,
            title,
            summary: summary || null,
            feedback: feedback || null,
            score: scoreRaw ? Number(scoreRaw) : null,
            rawData
          })
        });
        alert("리포트 제출 완료(검수대기).");
      });
    });
  }

  function boot(){
    const t = localStorage.getItem(TOKEN_KEY);
    if(t){
      $("loginCard").classList.add("d-none");
      $("app").classList.remove("d-none");
      load().catch(()=>{});
    }
  }

  $("loginBtn").addEventListener("click", login);
  $("logoutBtn").addEventListener("click", ()=>{ localStorage.removeItem(TOKEN_KEY); location.reload(); });
  boot();
})();
</script>
</body>
</html>
