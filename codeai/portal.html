<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CodeAI 학부모 포털</title>
  <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <script src="codeai-config.js"></script>
  <script src="codeai-api.js"></script>
  <style>
    body { background:#f7f8fb; }
    .card { border-radius:16px; }
    .muted { color:#6c757d; }
    .kpi-card{background:#fff;border-radius:16px;padding:14px;box-shadow:0 6px 18px rgba(16,24,40,.06);border:1px solid rgba(16,24,40,.06);}
.kpi-title{font-size:12px;color:#6c757d;margin-bottom:4px;}
.kpi-value{font-size:22px;font-weight:700;line-height:1.1;}
.kpi-delta{font-size:12px;margin-top:6px;}
.chart-card{background:#fff;border-radius:16px;padding:14px;box-shadow:0 6px 18px rgba(16,24,40,.06);border:1px solid rgba(16,24,40,.06);}
.canvas-wrap{height:140px;}
canvas{width:100%;height:140px;}
.section-title{font-weight:700;}
.badge-soft{background:#eef2ff;color:#374151;border:1px solid #e5e7eb;}
.mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>
<body>
  <div class="container py-4">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <div>
        <h3 class="mb-1">학부모 포털</h3>
        <div class="muted">최근 12주 주간 학습보고서(승인본)</div>
      </div>
      <div class="text-end">
        <a href="index.html" class="btn btn-sm btn-outline-secondary">홈으로</a>
      </div>
    </div>

    <div id="loginCard" class="card p-3 mb-3">
      <div class="row g-2 align-items-end">
        <div class="col-md-5">
          <label class="form-label">학부모 전화번호</label>
          <input id="phone" class="form-control" placeholder="01012345678" />
        </div>
        <div class="col-md-5">
          <label class="form-label">학부모 코드(6자리)</label>
          <input id="code" class="form-control mono" placeholder="123456" />
          <div class="small muted mt-1">※ 코드는 결제완료/재발급 시 안내됩니다.</div>
        </div>
        <div class="col-md-2 d-grid">
          <button id="btnLogin" class="btn btn-primary">로그인</button>
        </div>
      </div>
      <div id="loginMsg" class="small muted mt-2"></div>
    </div>

    <div id="app" class="d-none">
      <div class="card p-3 mb-3">
        <div class="row g-2 align-items-end">
          <div class="col-md-8">
            <label class="form-label mb-1">수강 선택</label>
            <select id="enrSel" class="form-select"></select>
          </div>
          <div class="col-md-4 d-grid">
            <button id="btnLoad" class="btn btn-outline-primary">주간보고서 불러오기</button>
          </div>
        </div>
        <div id="appMsg" class="small muted mt-2"></div>
      </div>

      <div id="reports"></div>
    </div>
  </div>

<script>
(function(){
  const TOKEN_KEY = "codeai_portal_token";
  const $ = (id)=>document.getElementById(id);
  const esc = (s)=>String(s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");

  async function doLogin(){
    $("loginMsg").textContent = "로그인 중…";
    try{
      const out = await CodeAI.request("/api/v1/portal/login", {
        method:"POST",
        body: JSON.stringify({ phone: $("phone").value.trim(), code: $("code").value.trim() })
      });
      localStorage.setItem(TOKEN_KEY, out.token);
      $("loginCard").classList.add("d-none");
      $("app").classList.remove("d-none");
      $("loginMsg").textContent = "";
      await loadEnrollments();
    }catch(e){
      $("loginMsg").textContent = "로그인 실패: " + e.message;
    }
  }
  $("btnLogin").addEventListener("click", doLogin);

  async function loadEnrollments(){
    $("appMsg").textContent = "수강 목록 불러오는 중…";
    try{
      const out = await CodeAI.authRequest("/api/v1/portal/enrollments", TOKEN_KEY, { method:"GET" });
      const list = out.enrollments || [];
      const sel = $("enrSel");
      sel.innerHTML = list.map(e=>{
        const label = `#${e.id} / ${e.instructor_name || "강사"} / ${e.status}`;
        return `<option value="${e.id}">${esc(label)}</option>`;
      }).join("");
      $("appMsg").textContent = list.length ? "수강을 선택 후 불러오기를 눌러주세요." : "연결된 수강이 없습니다.";
      if(list.length) await loadWeekly();
    }catch(e){
      $("appMsg").textContent = "오류: " + e.message;
    }
  }

  async function loadWeekly(){
    const eid = Number($("enrSel").value);
    if(!eid) return;
    $("appMsg").textContent = "주간보고서 불러오는 중…";
    try{
      const out = await CodeAI.authRequest(`/api/v1/portal/enrollments/${eid}/weekly-reports`, TOKEN_KEY, { method:"GET" });
      const list = out.reports || [];
      $("reports").innerHTML = (()=> {
        // sort ascending by week_start_date
        const sorted = [...list].sort((a,b)=> String(a.week_start_date).localeCompare(String(b.week_start_date)));
        const parseMetrics = (r)=>{
          try{
            const mj = r.metrics_json ? (typeof r.metrics_json === "string" ? JSON.parse(r.metrics_json) : r.metrics_json) : {};
            return mj || {};
          }catch(_){ return {}; }
        };
        const toNum = (v)=>{
          if(v===null || v===undefined || v==="") return null;
          const n = Number(v);
          return Number.isFinite(n) ? n : null;
        };
        const series = (key)=> sorted.map(r=> toNum(parseMetrics(r)[key]));
        const avg = (arr)=>{
          const xs = arr.filter(x=>x!==null);
          if(!xs.length) return null;
          return xs.reduce((s,x)=>s+x,0)/xs.length;
        };
        const lastNonNull = (arr)=>{
          for(let i=arr.length-1;i>=0;i--) if(arr[i]!==null) return {v:arr[i], i};
          return {v:null, i:-1};
        };
        const fmt = (n, digits=0)=> (n===null ? "-" : (digits? n.toFixed(digits): String(Math.round(n))));
        const deltaStr = (curr, prev, inverse=false)=>{
          if(curr===null || prev===null) return `<span class="muted">전주 비교 -</span>`;
          const d = curr - prev;
          const up = d>0;
          const good = inverse ? !up : up;
          const cls = good ? "text-success" : (d===0 ? "muted" : "text-danger");
          const sign = d>0?"+":(d<0?"":"");
          return `<span class="${cls}">${sign}${d.toFixed(1)}</span> <span class="muted">vs 전주</span>`;
        };

        const algoS = sorted.map(r=> toNum(r.algo_score));
        const attS = series("attendance");
        const hwS  = series("homework_done");
        const focS = series("focus");
        const misS = series("mistakes");

        const lastAlgo = lastNonNull(algoS); const prevAlgo = lastAlgo.i>0 ? algoS[lastAlgo.i-1] : null;
        const lastAtt  = lastNonNull(attS);  const prevAtt  = lastAtt.i>0  ? attS[lastAtt.i-1]  : null;
        const lastHw   = lastNonNull(hwS);   const prevHw   = lastHw.i>0   ? hwS[lastHw.i-1]   : null;
        const lastFoc  = lastNonNull(focS);  const prevFoc  = lastFoc.i>0  ? focS[lastFoc.i-1]  : null;
        const lastMis  = lastNonNull(misS);  const prevMis  = lastMis.i>0  ? misS[lastMis.i-1]  : null;

        const lastWeek = sorted.length ? sorted[sorted.length-1].week_start_date : "-";

        const buildDashboardHtml = (viewN)=>{
          const sortedAll = sorted;
          const slice = (viewN && sortedAll.length>viewN) ? sortedAll.slice(sortedAll.length-viewN) : sortedAll.slice();
          const vN = slice.length;

          const seriesV = (key)=> slice.map(r=> toNum(parseMetrics(r)[key]));
          const algoS = slice.map(r=> toNum(r.algo_score));
          const attS = seriesV("attendance");
          const hwS  = seriesV("homework_done");
          const focS = seriesV("focus");
          const misS = seriesV("mistakes");

          const lastWeek = slice.length ? (slice[slice.length-1].week_start_date || "-") : "-";

          const lastNonNull = (arr)=>{
            for(let i=arr.length-1;i>=0;i--) if(arr[i]!==null) return {v:arr[i], i};
            return {v:null, i:-1};
          };

          const avg = (arr)=>{
            const xs = arr.filter(x=>x!==null);
            if(!xs.length) return null;
            return xs.reduce((s,x)=>s+x,0)/xs.length;
          };

          const lastAlgo = lastNonNull(algoS); const prevAlgo = lastAlgo.i>0 ? algoS[lastAlgo.i-1] : null;
          const lastAtt  = lastNonNull(attS);  const prevAtt  = lastAtt.i>0  ? attS[lastAtt.i-1]  : null;
          const lastHw   = lastNonNull(hwS);   const prevHw   = lastHw.i>0   ? hwS[lastHw.i-1]   : null;
          const lastFoc  = lastNonNull(focS);  const prevFoc  = lastFoc.i>0  ? focS[lastFoc.i-1]  : null;
          const lastMis  = lastNonNull(misS);  const prevMis  = lastMis.i>0  ? misS[lastMis.i-1]  : null;

          // comment summary (latest week)
          const last = slice.length ? slice[slice.length-1] : null;
          const lastMetrics = last ? parseMetrics(last) : {};
          const rawComment = (last && (last.instructor_comment || last.project_feedback || lastMetrics.project_feedback || lastMetrics.comment)) || "";
          const comment = String(rawComment||"").trim();

          const stop = new Set(["그리고","하지만","그래서","또한","이번","이번주","다음","주차","학생","수업","과제","숙제","진행","오늘","이번주에","합니다","했습니다","합니다.","했습니다.","있는","없는","및","the","and","or","to","of","a","an","in","on","for","is","are"]);
          const tokens = comment
            .replace(/[\n\r\t]/g," ")
            .replace(/[^\w가-힣\s]/g," ")
            .split(/\s+/)
            .map(w=>w.trim())
            .filter(w=>w.length>=2 && !stop.has(w.toLowerCase()));
          const freq = {};
          tokens.forEach(w=>{ const k=w.toLowerCase(); freq[k]=(freq[k]||0)+1; });
          const top = Object.entries(freq).sort((a,b)=>b[1]-a[1]).slice(0,6).map(x=>x[0]);

          const hi = (txt)=>{
            let out = esc(txt);
            top.forEach(k=>{
              if(!k) return;
              const re = new RegExp(`(${k.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")})`,"gi");
              out = out.replace(re, '<mark class="px-1">$1</mark>');
            });
            return out;
          };

          const commentHtml = comment
            ? `<div class="small muted mb-2">최신 주차 코멘트에서 키워드 추출</div>
               <div class="d-flex flex-wrap gap-2 mb-2">
                 ${top.length? top.map(k=>`<span class="badge text-bg-light border kw-chip" data-kw="${esc(k)}" style="cursor:pointer;user-select:none">${esc(k)}</span>`).join("") : `<span class="muted">키워드가 부족합니다.</span>`}
               </div>
               <div class="p-3 bg-white rounded-3 border" style="line-height:1.6">${hi(comment.length>260? comment.slice(0,260)+"…" : comment)}</div>`
            : `<div class="muted">이번주 코멘트가 아직 없습니다.</div>`;

          const cards = `
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div class="section-title">최근 ${vN}주 대시보드</div>
              <div class="btn-group btn-group-sm" role="group" aria-label="view toggle">
                <button class="btn btn-outline-primary" id="btnView12" ${viewN===12?'aria-pressed="true"':''}>최근 12주</button>
                <button class="btn btn-outline-primary" id="btnView4"  ${viewN===4?'aria-pressed="true"':''}>최근 4주</button>
              </div>
            </div>

            <div class="card p-3 mb-3">
              <div class="section-title mb-2">이번주 코멘트 요약</div>
              <div id="commentSummary">${commentHtml}</div>
            

<div class="card p-3 mb-3 compare-card">
  <div class="d-flex justify-content-between align-items-center mb-2">
    <div class="section-title">최근 4주 vs 이전 8주 평균</div>
    <div class="muted small">최근 12주 기준</div>
  </div>
  <div id="compareWrap">${renderComparison(sortedAll)}</div>
</div></div>

            <div class="row g-3 mb-3">
              <div class="col-md-3">
                <div class="kpi-card">
                  <div class="kpi-title">이번주(최신) 주차</div>
                  <div class="kpi-value mono">${esc(lastWeek)}</div>
                  <div class="kpi-delta muted">최근 ${vN}주 승인본</div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="kpi-card">
                  <div class="kpi-title">알고 점수</div>
                  <div class="kpi-value">${fmt(lastAlgo.v,1)}</div>
                  <div class="kpi-delta">${deltaStr(lastAlgo.v, prevAlgo)}</div>
                  <div class="small muted mt-1">평균 ${fmt(avg(algoS),1)}</div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="kpi-card">
                  <div class="kpi-title">숙제 수행</div>
                  <div class="kpi-value">${fmt(lastHw.v,0)}</div>
                  <div class="kpi-delta">${deltaStr(lastHw.v, prevHw)}</div>
                  <div class="small muted mt-1">평균 ${fmt(avg(hwS),0)}</div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="kpi-card">
                  <div class="kpi-title">집중도</div>
                  <div class="kpi-value">${fmt(lastFoc.v,0)}</div>
                  <div class="kpi-delta">${deltaStr(lastFoc.v, prevFoc)}</div>
                  <div class="small muted mt-1">평균 ${fmt(avg(focS),0)}</div>
                </div>
              </div>
            

<div class="card p-3 mb-3 compare-card">
  <div class="d-flex justify-content-between align-items-center mb-2">
    <div class="section-title">최근 4주 vs 이전 8주 평균</div>
    <div class="muted small">최근 12주 기준</div>
  </div>
  <div id="compareWrap">${renderComparison(sortedAll)}</div>
</div></div>

            <div class="row g-3 mb-3">
              <div class="col-md-4">
                <div class="chart-card">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <div class="section-title">알고 점수 추이</div>
                    <div class="muted small">${vN}주</div>
                  </div>
                  <div class="canvas-wrap"><canvas id="cAlgo" width="600" height="200"></canvas></div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="chart-card">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <div class="section-title">숙제 수행 추이</div>
                    <div class="muted small">${vN}주</div>
                  </div>
                  <div class="canvas-wrap"><canvas id="cHw" width="600" height="200"></canvas></div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="chart-card">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <div class="section-title">집중도 추이</div>
                    <div class="muted small">${vN}주</div>
                  </div>
                  <div class="canvas-wrap"><canvas id="cFoc" width="600" height="200"></canvas></div>
                </div>
              </div>
            

<div class="card p-3 mb-3 compare-card">
  <div class="d-flex justify-content-between align-items-center mb-2">
    <div class="section-title">최근 4주 vs 이전 8주 평균</div>
    <div class="muted small">최근 12주 기준</div>
  </div>
  <div id="compareWrap">${renderComparison(sortedAll)}</div>
</div></div>

            <div class="row g-3 mb-3">
              <div class="col-md-6">
                <div class="chart-card">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <div class="section-title">오답(막대)</div>
                    <div class="muted small">${vN}주</div>
                  </div>
                  <div class="canvas-wrap"><canvas id="cMis" width="600" height="220"></canvas></div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="chart-card">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <div class="section-title">출석(스택)</div>
                    <div class="muted small">${vN}주</div>
                  </div>
                  <div class="canvas-wrap"><canvas id="cAtt" width="600" height="220"></canvas></div>
                </div>
              </div>
            </div>

            <div class="card p-3">
              <div class="section-title mb-2">주차 비교</div>
              <div class="table-responsive">
                <table class="table table-sm align-middle">
                  <thead>
                    <tr class="muted">
                      <th>주차</th><th class="text-end">출석</th><th class="text-end">숙제</th><th class="text-end">집중</th><th class="text-end">오답</th><th class="text-end">알고</th><th>피드백</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${slice.map(r=>{
                      const m = parseMetrics(r);
                      const fb = (r.instructor_comment || r.project_feedback || m.project_feedback || "") || "";
                      return `<tr>
                        <td class="mono">${esc(r.week_start_date||"-")}</td>
                        <td class="text-end">${fmt(toNum(m.attendance),0)}</td>
                        <td class="text-end">${fmt(toNum(m.homework_done),0)}</td>
                        <td class="text-end">${fmt(toNum(m.focus),0)}</td>
                        <td class="text-end">${fmt(toNum(m.mistakes),0)}</td>
                        <td class="text-end">${fmt(toNum(r.algo_score),1)}</td>
                        <td class="small">${esc(String(fb).slice(0,120))}${String(fb).length>120?"…":""}</td>
                      </tr>`;
                    }).join("")}
                  </tbody>
                </table>
              </div>
            </div>
          `;

          // chart helpers
          setTimeout(()=>{
            const drawLine = (cid, arr)=>{
              const c = document.getElementById(cid);
              if(!c) return;
              const ctx = c.getContext("2d");
              const w = c.width, h = c.height;
              ctx.clearRect(0,0,w,h);
              const xs = arr.map(v=> (v===null? null : Number(v)));
              const vals = xs.filter(v=>v!==null);
              if(vals.length<2){
                ctx.fillStyle="#6c757d";
                ctx.font="14px system-ui";
                ctx.fillText("데이터가 부족합니다", 10, 24);
                return;
              }
              const min = Math.min(...vals);
              const max = Math.max(...vals);
              const pad = 24;
              const xStep = (w - pad*2) / (xs.length-1);
              const y = (v)=>{
                if(max===min) return h/2;
                return (h-pad) - ((v-min)/(max-min))*(h-pad*2);
              };
              ctx.strokeStyle="rgba(16,24,40,.08)";
              ctx.lineWidth=1;
              for(let i=0;i<4;i++){
                const yy = pad + (i*(h-pad*2)/3);
                ctx.beginPath(); ctx.moveTo(pad,yy); ctx.lineTo(w-pad,yy); ctx.stroke();
              }
              ctx.strokeStyle="rgba(37,99,235,.9)";
              ctx.lineWidth=2;
              ctx.beginPath();
              xs.forEach((v,i)=>{
                if(v===null) return;
                const xx = pad + i*xStep;
                const yy = y(v);
                if(i===0 || xs.slice(0,i).every(z=>z===null)) ctx.moveTo(xx,yy);
                else ctx.lineTo(xx,yy);
              });
              ctx.stroke();
              ctx.fillStyle="rgba(37,99,235,.9)";
              xs.forEach((v,i)=>{
                if(v===null) return;
                const xx = pad + i*xStep;
                const yy = y(v);
                ctx.beginPath(); ctx.arc(xx,yy,3,0,Math.PI*2); ctx.fill();
              });
              ctx.fillStyle="#6c757d";
              ctx.font="12px system-ui";
              ctx.fillText(String(max.toFixed(1)), 8, pad+4);
              ctx.fillText(String(min.toFixed(1)), 8, h-pad+4);
            };

            const drawBars = (cid, arr)=>{
              const c = document.getElementById(cid);
              if(!c) return;
              const ctx = c.getContext("2d");
              const w=c.width, h=c.height;
              ctx.clearRect(0,0,w,h);
              const xs = arr.map(v=> (v===null? null : Number(v)));
              const vals = xs.filter(v=>v!==null);
              const pad=28;
              if(!vals.length){
                ctx.fillStyle="#6c757d"; ctx.font="14px system-ui"; ctx.fillText("데이터가 없습니다", 10, 24);
                return;
              }
              const max = Math.max(...vals, 1);
              const barW = (w-pad*2)/xs.length;
              // grid
              ctx.strokeStyle="rgba(16,24,40,.08)";
              for(let i=0;i<4;i++){
                const yy = pad + (i*(h-pad*2)/3);
                ctx.beginPath(); ctx.moveTo(pad,yy); ctx.lineTo(w-pad,yy); ctx.stroke();
              }
              xs.forEach((v,i)=>{
                const xx = pad + i*barW + 4;
                const bw = Math.max(2, barW-8);
                const val = v===null?0:v;
                const bh = (h-pad*2)*(val/max);
                const yy = (h-pad) - bh;
                ctx.fillStyle = "rgba(239,68,68,.75)";
                ctx.fillRect(xx, yy, bw, bh);
              });
              ctx.fillStyle="#6c757d"; ctx.font="12px system-ui";
              ctx.fillText(String(max.toFixed(0)), 8, pad+4);
              ctx.fillText("0", 12, h-pad+4);
            };

            const drawStack = (cid, arr)=>{
              const c = document.getElementById(cid);
              if(!c) return;
              const ctx=c.getContext("2d");
              const w=c.width, h=c.height;
              ctx.clearRect(0,0,w,h);
              const xs = arr.map(v=> (v===null? null : Number(v)));
              const vals = xs.filter(v=>v!==null);
              const pad=28;
              if(!vals.length){
                ctx.fillStyle="#6c757d"; ctx.font="14px system-ui"; ctx.fillText("데이터가 없습니다", 10, 24);
                return;
              }
              let maxV = Math.max(...vals);
              let scale = 100;
              let conv = (v)=>v;
              if(maxV<=1.5){ conv = (v)=>v*100; }
              else if(maxV>100){ scale=maxV; }
              const barW=(w-pad*2)/xs.length;
              // grid
              ctx.strokeStyle="rgba(16,24,40,.08)";
              for(let i=0;i<4;i++){
                const yy = pad + (i*(h-pad*2)/3);
                ctx.beginPath(); ctx.moveTo(pad,yy); ctx.lineTo(w-pad,yy); ctx.stroke();
              }
              xs.forEach((v,i)=>{
                const xx=pad + i*barW + 4;
                const bw=Math.max(2, barW-8);
                const p = v===null?0: Math.max(0, Math.min(scale, conv(v)));
                const a = scale - p;
                const ph = (h-pad*2)*(p/scale);
                const ah = (h-pad*2)*(a/scale);
                const y0 = h-pad;
                // present
                ctx.fillStyle="rgba(34,197,94,.75)";
                ctx.fillRect(xx, y0-ph, bw, ph);
                // absent on top? stack downward: absent is remainder (gray) above present
                ctx.fillStyle="rgba(148,163,184,.7)";
                ctx.fillRect(xx, y0-ph-ah, bw, ah);
              });
              ctx.fillStyle="#6c757d"; ctx.font="12px system-ui";
              ctx.fillText(String(scale), 8, pad+4);
              ctx.fillText("0", 12, h-pad+4);
              ctx.fillText("출석(초록)+결석/미출석(회색)", pad, 16);
            };

            drawLine("cAlgo", algoS);
            drawLine("cHw",  hwS);
            drawLine("cFoc", focS);
            drawBars("cMis", misS);
            drawStack("cAtt", attS);

            const b12=document.getElementById("btnView12");
            const b4=document.getElementById("btnView4");
            if(b12) b12.onclick = ()=>{ window.__portalViewN=12; $("reports").innerHTML = buildDashboardHtml(12); };
            if(b4)  b4.onclick  = ()=>{ window.__portalViewN=4;  $("reports").innerHTML = buildDashboardHtml(4);  };
          

// 키워드 칩 클릭: 특정 키워드만 하이라이트 토글
const chips = document.querySelectorAll(".kw-chip");
const avail = new Set(Array.from(chips).map(el=> (el.getAttribute("data-kw")||"").toLowerCase()));
if(window.__kwSelected && !avail.has(String(window.__kwSelected).toLowerCase())) window.__kwSelected = null;

const paint = ()=>{
  chips.forEach(el=>{
    const k = (el.getAttribute("data-kw")||"");
    const on = window.__kwSelected && k.toLowerCase()===String(window.__kwSelected).toLowerCase();
    el.classList.toggle("text-bg-primary", !!on);
    el.classList.toggle("text-bg-light", !on);
  });
};
chips.forEach(el=>{
  el.addEventListener("click", ()=>{
    const k = (el.getAttribute("data-kw")||"").trim();
    if(!k) return;
    window.__kwSelected = (window.__kwSelected && k.toLowerCase()===String(window.__kwSelected).toLowerCase()) ? null : k;
    $("reports").innerHTML = buildDashboardHtml(window.__portalViewN || 12);
  });
});
paint();
          },0);

          return cards;
        };

        window.__portalViewN = window.__portalViewN || 12;
        window.__kwSelected = window.__kwSelected || null;
        return buildDashboardHtml(window.__portalViewN);\n      })();
      $("appMsg").textContent = "";
    }catch(e){
      $("appMsg").textContent = "오류: " + e.message;
    }
  }

  $("btnLoad").addEventListener("click", loadWeekly);

  (async ()=>{
    if(localStorage.getItem(TOKEN_KEY)){
      $("loginCard").classList.add("d-none");
      $("app").classList.remove("d-none");
      await loadEnrollments();
    }
  })();
})();
</script>
</body>
</html>

function renderComparison(sortedAll){
  const n = sortedAll.length;
  const slice12 = n>12 ? sortedAll.slice(n-12) : sortedAll.slice();
  if(slice12.length < 6){
    return `<div class="muted">비교할 데이터가 부족합니다. (최소 6주 이상 필요)</div>`;
  }
  const last4 = slice12.slice(Math.max(0, slice12.length-4));
  const prev8 = slice12.slice(0, Math.max(0, slice12.length-4));
  const parseMetrics = (r)=>{
    try{
      const mj = r.metrics_json ? (typeof r.metrics_json === "string" ? JSON.parse(r.metrics_json) : r.metrics_json) : {};
      return mj || {};
    }catch(_){ return {}; }
  };
  const toNum = (v)=>{
    if(v===null || v===undefined || v==="") return null;
    const num = Number(v);
    return Number.isFinite(num) ? num : null;
  };
  const avg = (arr)=>{
    const xs = arr.filter(x=>x!==null);
    if(!xs.length) return null;
    return xs.reduce((s,x)=>s+x,0)/xs.length;
  };
  const series = (arr, key, direct=true)=>{
    return arr.map(r=>{
      if(key==="algo_score") return toNum(r.algo_score);
      const m = parseMetrics(r);
      return toNum(m[key]);
    });
  };
  const fmt = (n, digits=1)=> (n===null ? "-" : n.toFixed(digits));
  const deltaBadge = (d, inverse=false)=>{
    if(d===null) return `<span class="badge text-bg-light border">-</span>`;
    const up = d>0;
    const good = inverse ? !up : up;
    const cls = d===0 ? "text-bg-light border" : (good ? "text-bg-success" : "text-bg-danger");
    const sign = d>0?"+":(d<0?"":"");
    return `<span class="badge ${cls}">${sign}${d.toFixed(1)}</span>`;
  };

  const keys = [
    {label:"알고 점수", key:"algo_score", inverse:false},
    {label:"숙제 수행", key:"homework_done", inverse:false},
    {label:"집중도",   key:"focus", inverse:false},
    {label:"오답",     key:"mistakes", inverse:true},
    {label:"출석",     key:"attendance", inverse:false},
  ];

  const rows = keys.map(k=>{
    const a4 = avg(series(last4, k.key));
    const a8 = avg(series(prev8, k.key));
    let d = (a4===null || a8===null) ? null : (a4 - a8);
    // normalize attendance if 0~1
    if(k.key==="attendance"){
      const norm = (x)=> (x!==null && x<=1 ? x*100 : x);
      const na4 = a4===null? null : norm(a4);
      const na8 = a8===null? null : norm(a8);
      d = (na4===null || na8===null) ? null : (na4-na8);
      return { ...k, a4: na4, a8: na8, d };
    }
    return { ...k, a4, a8, d };
  });

  const goodCount = rows.filter(r=> r.d!==null && (r.inverse ? r.d<0 : r.d>0)).length;
  const badCount  = rows.filter(r=> r.d!==null && (r.inverse ? r.d>0 : r.d<0)).length;

  const summarize = ()=>{
    const parts = [];
    rows.forEach(r=>{
      if(r.d===null || r.d===0) return;
      const up = r.d>0;
      const verb = (r.inverse ? (up?"증가":"감소") : (up?"상승":"하락"));
      parts.push(`${r.label} ${Math.abs(r.d).toFixed(1)} ${verb}`);
    });
    if(!parts.length) return "최근 4주와 이전 기간의 평균 차이가 크지 않습니다.";
    return `최근 4주는 이전 8주 대비 ${parts.slice(0,3).join(", ")}했습니다.`;
  };

  return `
    <div class="row g-3">
      <div class="col-lg-4">
        <div class="p-3 bg-white rounded-3 border h-100">
          <div class="small muted mb-1">자동 요약</div>
          <div style="line-height:1.6">${summarize()}</div>
          <div class="small muted mt-2">개선 지표 ${goodCount}개 · 악화 지표 ${badCount}개</div>
        </div>
      </div>
      <div class="col-lg-8">
        <div class="table-responsive">
          <table class="table table-sm align-middle mb-0">
            <thead>
              <tr class="muted">
                <th>지표</th>
                <th class="text-end">최근 4주 평균</th>
                <th class="text-end">이전 8주 평균</th>
                <th class="text-end">변화</th>
              </tr>
            </thead>
            <tbody>
              ${rows.map(r=>`
                <tr>
                  <td>${r.label}</td>
                  <td class="text-end mono">${fmt(r.a4,1)}</td>
                  <td class="text-end mono">${fmt(r.a8,1)}</td>
                  <td class="text-end">${deltaBadge(r.d, r.inverse)}</td>
                </tr>
              `).join("")}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  `;
}


